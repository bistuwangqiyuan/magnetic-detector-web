<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨ç½²æµ‹è¯• - ç£æ£€æµ‹ä»ªå™¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #FF6B1A;
            border-bottom: 3px solid #FF6B1A;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ccc;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .test-item.pass {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .test-item.fail {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .test-item.running {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-result {
            font-size: 14px;
            color: #666;
        }
        .button {
            background: #FF6B1A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #e55a0f;
        }
        .summary {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .summary-card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-number {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        .summary-card.pass .summary-number { color: #28a745; }
        .summary-card.fail .summary-number { color: #dc3545; }
        .summary-card.total .summary-number { color: #007bff; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç£æ£€æµ‹ä»ªå™¨ç½‘é¡µç‰ˆ - éƒ¨ç½²æµ‹è¯•</h1>
    
    <div class="summary">
        <div class="summary-card total">
            <div>æ€»æµ‹è¯•æ•°</div>
            <div class="summary-number" id="total-tests">0</div>
        </div>
        <div class="summary-card pass">
            <div>é€šè¿‡</div>
            <div class="summary-number" id="passed-tests">0</div>
        </div>
        <div class="summary-card fail">
            <div>å¤±è´¥</div>
            <div class="summary-number" id="failed-tests">0</div>
        </div>
    </div>

    <div style="text-align: center;">
        <button class="button" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button class="button" onclick="location.href='index.html'">â†©ï¸ è¿”å›ä¸»é¡µ</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“„ é¡µé¢åŠ è½½æµ‹è¯•</h2>
        <div id="page-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“š ä¾èµ–åº“æµ‹è¯•</h2>
        <div id="library-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ—„ï¸ æ•°æ®åº“è¿æ¥æµ‹è¯•</h2>
        <div id="database-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ åŠŸèƒ½æ¨¡å—æµ‹è¯•</h2>
        <div id="module-tests"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•è¯¦ç»†æ—¥å¿—</h2>
        <pre id="test-log"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            details: []
        };

        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
        }

        function addTestResult(container, name, passed, details = '') {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            const testItem = document.createElement('div');
            testItem.className = `test-item ${passed ? 'pass' : 'fail'}`;
            testItem.innerHTML = `
                <div class="test-name">${passed ? 'âœ…' : 'âŒ'} ${name}</div>
                <div class="test-result">${details}</div>
            `;
            document.getElementById(container).appendChild(testItem);
            updateSummary();
            
            log(`${passed ? 'âœ… PASS' : 'âŒ FAIL'}: ${name} - ${details}`);
        }

        async function testPageAccess(pageName, url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.ok) {
                    addTestResult('page-tests', `${pageName} é¡µé¢`, true, `çŠ¶æ€ç : ${response.status}`);
                } else {
                    addTestResult('page-tests', `${pageName} é¡µé¢`, false, `çŠ¶æ€ç : ${response.status}`);
                }
            } catch (error) {
                addTestResult('page-tests', `${pageName} é¡µé¢`, false, `é”™è¯¯: ${error.message}`);
            }
        }

        function testLibraryLoaded(libName, testFunc) {
            const loaded = testFunc();
            addTestResult('library-tests', `${libName} åº“`, loaded, 
                loaded ? 'å·²æ­£ç¡®åŠ è½½' : 'åŠ è½½å¤±è´¥æˆ–æœªå®šä¹‰');
        }

        async function testDatabaseConnection() {
            try {
                // æµ‹è¯• Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–
                if (typeof supabase === 'undefined') {
                    addTestResult('database-tests', 'Supabase åº“åŠ è½½', false, 'Supabase æœªå®šä¹‰');
                    return;
                }
                addTestResult('database-tests', 'Supabase åº“åŠ è½½', true, 'åº“å·²æ­£ç¡®åŠ è½½');

                // æµ‹è¯•é…ç½®
                if (SUPABASE_CONFIG && SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
                    addTestResult('database-tests', 'Supabase é…ç½®', true, 
                        `URL: ${SUPABASE_CONFIG.url.substring(0, 30)}...`);
                } else {
                    addTestResult('database-tests', 'Supabase é…ç½®', false, 'é…ç½®ç¼ºå¤±');
                    return;
                }

                // æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–
                const dbInit = await initDatabase();
                addTestResult('database-tests', 'æ•°æ®åº“åˆå§‹åŒ–', dbInit, 
                    dbInit ? 'æˆåŠŸè¿æ¥' : 'åˆå§‹åŒ–å¤±è´¥');

                // æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢
                try {
                    const records = await getTestRecords({}, { limit: 1 });
                    addTestResult('database-tests', 'æ•°æ®åº“æŸ¥è¯¢', true, 
                        `æˆåŠŸæŸ¥è¯¢ï¼Œè¿”å› ${records.length} æ¡è®°å½•`);
                } catch (error) {
                    addTestResult('database-tests', 'æ•°æ®åº“æŸ¥è¯¢', false, 
                        `æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                }
            } catch (error) {
                addTestResult('database-tests', 'æ•°æ®åº“è¿æ¥', false, 
                    `é”™è¯¯: ${error.message}`);
            }
        }

        function testModuleFunctions() {
            // æµ‹è¯•é…ç½®å¯¹è±¡
            addTestResult('module-tests', 'APP_CONFIG', 
                typeof APP_CONFIG !== 'undefined' && APP_CONFIG.appName,
                APP_CONFIG ? `åº”ç”¨åç§°: ${APP_CONFIG.appName}` : 'æœªå®šä¹‰');

            // æµ‹è¯•å·¥å…·å‡½æ•°
            addTestResult('module-tests', 'getCurrentTimestamp()', 
                typeof getCurrentTimestamp === 'function',
                typeof getCurrentTimestamp === 'function' ? `å½“å‰æ—¶é—´æˆ³: ${getCurrentTimestamp()}` : 'æœªå®šä¹‰');

            addTestResult('module-tests', 'formatDateTime()', 
                typeof formatDateTime === 'function',
                typeof formatDateTime === 'function' ? `æ ¼å¼åŒ–æ—¶é—´: ${formatDateTime(new Date())}` : 'æœªå®šä¹‰');

            addTestResult('module-tests', 'generateUUID()', 
                typeof generateUUID === 'function',
                typeof generateUUID === 'function' ? `UUID: ${generateUUID()}` : 'æœªå®šä¹‰');

            // æµ‹è¯•Logger
            addTestResult('module-tests', 'Logger å¯¹è±¡', 
                typeof Logger !== 'undefined' && typeof Logger.info === 'function',
                typeof Logger !== 'undefined' ? 'Logger å¯ç”¨' : 'æœªå®šä¹‰');

            // æµ‹è¯•ç¼ºé™·ç±»å‹
            addTestResult('module-tests', 'DEFECT_TYPES', 
                typeof DEFECT_TYPES !== 'undefined' && Object.keys(DEFECT_TYPES).length > 0,
                typeof DEFECT_TYPES !== 'undefined' ? `åŒ…å« ${Object.keys(DEFECT_TYPES).length} ç§ç¼ºé™·ç±»å‹` : 'æœªå®šä¹‰');

            // æµ‹è¯•æµ‹è¯•æ¨¡æ¿
            addTestResult('module-tests', 'TEST_TEMPLATES', 
                typeof TEST_TEMPLATES !== 'undefined' && Object.keys(TEST_TEMPLATES).length > 0,
                typeof TEST_TEMPLATES !== 'undefined' ? `åŒ…å« ${Object.keys(TEST_TEMPLATES).length} ä¸ªæµ‹è¯•æ¨¡æ¿` : 'æœªå®šä¹‰');
        }

        async function runAllTests() {
            // æ¸…ç©ºä¹‹å‰çš„æµ‹è¯•ç»“æœ
            testResults = { total: 0, passed: 0, failed: 0, details: [] };
            document.getElementById('page-tests').innerHTML = '';
            document.getElementById('library-tests').innerHTML = '';
            document.getElementById('database-tests').innerHTML = '';
            document.getElementById('module-tests').innerHTML = '';
            document.getElementById('test-log').textContent = '';
            updateSummary();

            log('========================================');
            log('å¼€å§‹è¿è¡Œéƒ¨ç½²æµ‹è¯•...');
            log('========================================');

            // é¡µé¢åŠ è½½æµ‹è¯•
            log('\nğŸ“„ æµ‹è¯•é¡µé¢åŠ è½½...');
            await testPageAccess('ä¸»é¡µé¢', 'index.html');
            await testPageAccess('å†å²æ•°æ®', 'pages/history.html');
            await testPageAccess('æ•°æ®åˆ†æ', 'pages/analysis.html');
            await testPageAccess('æŠ¥å‘Šç®¡ç†', 'pages/reports.html');
            await testPageAccess('å‚æ•°è®¾ç½®', 'pages/settings.html');
            await testPageAccess('æ ¡å‡†ç®¡ç†', 'pages/calibration.html');

            // ä¾èµ–åº“æµ‹è¯•
            log('\nğŸ“š æµ‹è¯•ä¾èµ–åº“...');
            testLibraryLoaded('Supabase', () => typeof supabase !== 'undefined');
            testLibraryLoaded('Config', () => typeof SUPABASE_CONFIG !== 'undefined');
            testLibraryLoaded('Database', () => typeof initDatabase === 'function');

            // æ•°æ®åº“è¿æ¥æµ‹è¯•
            log('\nğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“è¿æ¥...');
            await testDatabaseConnection();

            // åŠŸèƒ½æ¨¡å—æµ‹è¯•
            log('\nğŸ”§ æµ‹è¯•åŠŸèƒ½æ¨¡å—...');
            testModuleFunctions();

            log('\n========================================');
            log(`æµ‹è¯•å®Œæˆï¼æ€»è®¡: ${testResults.total}, é€šè¿‡: ${testResults.passed}, å¤±è´¥: ${testResults.failed}`);
            log('========================================');

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            if (testResults.failed === 0) {
                alert(`âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼(${testResults.passed}/${testResults.total})`);
            } else {
                alert(`âš ï¸ æµ‹è¯•å®Œæˆï¼Œä½†æœ‰ ${testResults.failed} ä¸ªæµ‹è¯•å¤±è´¥ã€‚è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿è¡Œæµ‹è¯•...\n');
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
