<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部署测试 - 磁检测仪器</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #FF6B1A;
            border-bottom: 3px solid #FF6B1A;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ccc;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .test-item.pass {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .test-item.fail {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .test-item.running {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .test-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-result {
            font-size: 14px;
            color: #666;
        }
        .button {
            background: #FF6B1A;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #e55a0f;
        }
        .summary {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .summary-card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .summary-number {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        .summary-card.pass .summary-number { color: #28a745; }
        .summary-card.fail .summary-number { color: #dc3545; }
        .summary-card.total .summary-number { color: #007bff; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🔧 磁检测仪器网页版 - 部署测试</h1>
    
    <div class="summary">
        <div class="summary-card total">
            <div>总测试数</div>
            <div class="summary-number" id="total-tests">0</div>
        </div>
        <div class="summary-card pass">
            <div>通过</div>
            <div class="summary-number" id="passed-tests">0</div>
        </div>
        <div class="summary-card fail">
            <div>失败</div>
            <div class="summary-number" id="failed-tests">0</div>
        </div>
    </div>

    <div style="text-align: center;">
        <button class="button" onclick="runAllTests()">🚀 运行所有测试</button>
        <button class="button" onclick="location.href='index.html'">↩️ 返回主页</button>
    </div>

    <div class="test-section">
        <h2>📄 页面加载测试</h2>
        <div id="page-tests"></div>
    </div>

    <div class="test-section">
        <h2>📚 依赖库测试</h2>
        <div id="library-tests"></div>
    </div>

    <div class="test-section">
        <h2>🗄️ 数据库连接测试</h2>
        <div id="database-tests"></div>
    </div>

    <div class="test-section">
        <h2>🔧 功能模块测试</h2>
        <div id="module-tests"></div>
    </div>

    <div class="test-section">
        <h2>📊 测试详细日志</h2>
        <pre id="test-log"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/database.js"></script>
    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            details: []
        };

        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
        }

        function addTestResult(container, name, passed, details = '') {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            const testItem = document.createElement('div');
            testItem.className = `test-item ${passed ? 'pass' : 'fail'}`;
            testItem.innerHTML = `
                <div class="test-name">${passed ? '✅' : '❌'} ${name}</div>
                <div class="test-result">${details}</div>
            `;
            document.getElementById(container).appendChild(testItem);
            updateSummary();
            
            log(`${passed ? '✅ PASS' : '❌ FAIL'}: ${name} - ${details}`);
        }

        async function testPageAccess(pageName, url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (response.ok) {
                    addTestResult('page-tests', `${pageName} 页面`, true, `状态码: ${response.status}`);
                } else {
                    addTestResult('page-tests', `${pageName} 页面`, false, `状态码: ${response.status}`);
                }
            } catch (error) {
                addTestResult('page-tests', `${pageName} 页面`, false, `错误: ${error.message}`);
            }
        }

        function testLibraryLoaded(libName, testFunc) {
            const loaded = testFunc();
            addTestResult('library-tests', `${libName} 库`, loaded, 
                loaded ? '已正确加载' : '加载失败或未定义');
        }

        async function testDatabaseConnection() {
            try {
                // 测试 Supabase 客户端初始化
                if (typeof supabase === 'undefined') {
                    addTestResult('database-tests', 'Supabase 库加载', false, 'Supabase 未定义');
                    return;
                }
                addTestResult('database-tests', 'Supabase 库加载', true, '库已正确加载');

                // 测试配置
                if (SUPABASE_CONFIG && SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
                    addTestResult('database-tests', 'Supabase 配置', true, 
                        `URL: ${SUPABASE_CONFIG.url.substring(0, 30)}...`);
                } else {
                    addTestResult('database-tests', 'Supabase 配置', false, '配置缺失');
                    return;
                }

                // 测试数据库初始化
                const dbInit = await initDatabase();
                addTestResult('database-tests', '数据库初始化', dbInit, 
                    dbInit ? '成功连接' : '初始化失败');

                // 测试数据库查询
                try {
                    const records = await getTestRecords({}, { limit: 1 });
                    addTestResult('database-tests', '数据库查询', true, 
                        `成功查询，返回 ${records.length} 条记录`);
                } catch (error) {
                    addTestResult('database-tests', '数据库查询', false, 
                        `查询失败: ${error.message}`);
                }
            } catch (error) {
                addTestResult('database-tests', '数据库连接', false, 
                    `错误: ${error.message}`);
            }
        }

        function testModuleFunctions() {
            // 测试配置对象
            addTestResult('module-tests', 'APP_CONFIG', 
                typeof APP_CONFIG !== 'undefined' && APP_CONFIG.appName,
                APP_CONFIG ? `应用名称: ${APP_CONFIG.appName}` : '未定义');

            // 测试工具函数
            addTestResult('module-tests', 'getCurrentTimestamp()', 
                typeof getCurrentTimestamp === 'function',
                typeof getCurrentTimestamp === 'function' ? `当前时间戳: ${getCurrentTimestamp()}` : '未定义');

            addTestResult('module-tests', 'formatDateTime()', 
                typeof formatDateTime === 'function',
                typeof formatDateTime === 'function' ? `格式化时间: ${formatDateTime(new Date())}` : '未定义');

            addTestResult('module-tests', 'generateUUID()', 
                typeof generateUUID === 'function',
                typeof generateUUID === 'function' ? `UUID: ${generateUUID()}` : '未定义');

            // 测试Logger
            addTestResult('module-tests', 'Logger 对象', 
                typeof Logger !== 'undefined' && typeof Logger.info === 'function',
                typeof Logger !== 'undefined' ? 'Logger 可用' : '未定义');

            // 测试缺陷类型
            addTestResult('module-tests', 'DEFECT_TYPES', 
                typeof DEFECT_TYPES !== 'undefined' && Object.keys(DEFECT_TYPES).length > 0,
                typeof DEFECT_TYPES !== 'undefined' ? `包含 ${Object.keys(DEFECT_TYPES).length} 种缺陷类型` : '未定义');

            // 测试测试模板
            addTestResult('module-tests', 'TEST_TEMPLATES', 
                typeof TEST_TEMPLATES !== 'undefined' && Object.keys(TEST_TEMPLATES).length > 0,
                typeof TEST_TEMPLATES !== 'undefined' ? `包含 ${Object.keys(TEST_TEMPLATES).length} 个测试模板` : '未定义');
        }

        async function runAllTests() {
            // 清空之前的测试结果
            testResults = { total: 0, passed: 0, failed: 0, details: [] };
            document.getElementById('page-tests').innerHTML = '';
            document.getElementById('library-tests').innerHTML = '';
            document.getElementById('database-tests').innerHTML = '';
            document.getElementById('module-tests').innerHTML = '';
            document.getElementById('test-log').textContent = '';
            updateSummary();

            log('========================================');
            log('开始运行部署测试...');
            log('========================================');

            // 页面加载测试
            log('\n📄 测试页面加载...');
            await testPageAccess('主页面', 'index.html');
            await testPageAccess('历史数据', 'pages/history.html');
            await testPageAccess('数据分析', 'pages/analysis.html');
            await testPageAccess('报告管理', 'pages/reports.html');
            await testPageAccess('参数设置', 'pages/settings.html');
            await testPageAccess('校准管理', 'pages/calibration.html');

            // 依赖库测试
            log('\n📚 测试依赖库...');
            testLibraryLoaded('Supabase', () => typeof supabase !== 'undefined');
            testLibraryLoaded('Config', () => typeof SUPABASE_CONFIG !== 'undefined');
            testLibraryLoaded('Database', () => typeof initDatabase === 'function');

            // 数据库连接测试
            log('\n🗄️ 测试数据库连接...');
            await testDatabaseConnection();

            // 功能模块测试
            log('\n🔧 测试功能模块...');
            testModuleFunctions();

            log('\n========================================');
            log(`测试完成！总计: ${testResults.total}, 通过: ${testResults.passed}, 失败: ${testResults.failed}`);
            log('========================================');

            // 显示最终结果
            if (testResults.failed === 0) {
                alert(`✅ 所有测试通过！(${testResults.passed}/${testResults.total})`);
            } else {
                alert(`⚠️ 测试完成，但有 ${testResults.failed} 个测试失败。请查看详细日志。`);
            }
        }

        // 页面加载时自动运行测试
        window.addEventListener('load', () => {
            log('页面加载完成，准备运行测试...\n');
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
